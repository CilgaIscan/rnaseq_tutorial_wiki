![RNA-seq Flowchart - Module 4](Images/RNA-seq_Flowchart4.png)

#3-i. Expression
Use Cufflinks to generate expression estimates from the SAM/BAM files generated by HISAT2 in the previous module

###Note on de novo transcript discovery and differential expression using Cufflinks and Cuffdiff
In this module, we will run Cufflinks in 'reference only' mode. For simplicity and to reduce run time, it is sometime useful to perform expression analysis with only known transcript models. However, Cufflinks can predict the transcripts present in each library instead (by dropping the '-G' option in cufflinks commands as described later in Module 5). Cufflinks will then assign arbitrary transcript IDs to each transcript assembled from the data and estimate expression for those transcripts. One complication with this method is that in each library a different set of transcripts is likely to be predicted for each library. There may be a lot of similarities but the number of transcripts and their exact structure will differ in the output files for each library. Before you can compare across libraries you therefore need to determine which transcripts correspond to each other across the libraries.

* Cufflinks provides 'cuffmerge' to combine predicted transcript GTF files from across different libraries
 * Once you have a merged GTF file you can run Cuffdiff with this instead of the known transcripts GTF file we used above
* Cufflinks also provides 'cuffcompare' to compare predicted transcripts to known transcripts
* Refer to the Cufflinks manual for a more detailed explanation:
 * http://cole-trapnell-lab.github.io/cufflinks/manual/

Cufflinks basic usage:

```bash

cufflinks [options] <hits.sam>

```

Extra options specified below:

'-p 8' tells Cufflinks to use eight CPUs
'-G/--GTF <known transcripts file>' Forces cufflinks to calculate expression values for just known transcripts (we call this "reference only" mode)
'--library-type fr-firststrand' Tells Cufflinks we are analyzing a strand-specific library protocol but is not required since TopHat provides the XS BAM tag.
'-o' tells Cufflinks to write output to a particular directory (one per sample)

```bash

cd $RNA_HOME/
mkdir -p expression/cufflinks/ref_only/
cd expression/cufflinks/ref_only/

cufflinks -p 8 -o HBR_Rep1 --library-type fr-firststrand --GTF $REF_GTF --no-update-check $RNA_ALIGN_DIR/HBR_Rep1.bam
cufflinks -p 8 -o HBR_Rep2 --library-type fr-firststrand --GTF $REF_GTF --no-update-check $RNA_ALIGN_DIR/HBR_Rep2.bam
cufflinks -p 8 -o HBR_Rep3 --library-type fr-firststrand --GTF $REF_GTF --no-update-check $RNA_ALIGN_DIR/HBR_Rep3.bam

cufflinks -p 8 -o UHR_Rep1 --library-type fr-firststrand --GTF $REF_GTF --no-update-check $RNA_ALIGN_DIR/UHR_Rep1.bam
cufflinks -p 8 -o UHR_Rep2 --library-type fr-firststrand --GTF $REF_GTF --no-update-check $RNA_ALIGN_DIR/UHR_Rep2.bam
cufflinks -p 8 -o UHR_Rep3 --library-type fr-firststrand --GTF $REF_GTF --no-update-check $RNA_ALIGN_DIR/UHR_Rep3.bam

```

What does the raw output from Cufflinks look like?

```bash

cd $RNA_HOME/expression/cufflinks/ref_only/UHR_Rep1/
ls -l
head isoforms.fpkm_tracking
cut -f 1,4,7-13 isoforms.fpkm_tracking | less

```

Press 'q' to exit the 'less' display

---
###OPTIONAL ALTERNATIVE - HTSEQ-COUNT
Run htseq-count on alignments instead to produce raw counts instead of FPKM values for differential expression analysis

Refer to the HTSeq documentation for a more detailed explanation:
* http://www-huber.embl.de/users/anders/HTSeq/doc/count.html

htseq-count basic usage:

```bash

htseq-count [options] <sam_file> <gff_file>

```

Extra options specified below:
* '--format' specify the input file format one of BAM or SAM. Since we have BAM format files, select 'bam' for this option.
* '--order' provide the expected sort order of the input file.  Previously we generated position sorted BAM files so use 'pos'.
* '--mode' determines how to deal with reads that overlap more than one feature. We believe the 'intersection-strict' mode is best.
* '--stranded' specifies whether data is stranded or not.  The TruSeq strand-specific RNA libraries suggest the 'reverse' option for this parameter.
* '--minaqual' will skip all reads with alignment quality lower than the given minimum value
* '--type' specifies the feature type (3rd column in GFF file) to be used. (default, suitable for RNA-Seq and Ensembl GTF files: exon)
* '--idattr' The feature ID used to identity the counts in the output table. The default, suitable for RNA-SEq and Ensembl GTF files, is gene_id.

Run htseq-count and calculate gene-level counts:

```bash

cd $RNA_HOME/
mkdir -p expression/htseq_counts
cd expression/htseq_counts

htseq-count --format bam --order pos --mode intersection-strict --stranded reverse --minaqual 1 --type exon --idattr gene_id $RNA_ALIGN_DIR/UHR_Rep1.bam $REF_GTF > UHR_Rep1_gene.tsv
htseq-count --format bam --order pos --mode intersection-strict --stranded reverse --minaqual 1 --type exon --idattr gene_id $RNA_ALIGN_DIR/UHR_Rep2.bam $REF_GTF > UHR_Rep2_gene.tsv
htseq-count --format bam --order pos --mode intersection-strict --stranded reverse --minaqual 1 --type exon --idattr gene_id $RNA_ALIGN_DIR/UHR_Rep3.bam $REF_GTF > UHR_Rep3_gene.tsv

htseq-count --format bam --order pos --mode intersection-strict --stranded reverse --minaqual 1 --type exon --idattr gene_id $RNA_ALIGN_DIR/HBR_Rep1.bam $REF_GTF > HBR_Rep1_gene.tsv
htseq-count --format bam --order pos --mode intersection-strict --stranded reverse --minaqual 1 --type exon --idattr gene_id $RNA_ALIGN_DIR/HBR_Rep2.bam $REF_GTF > HBR_Rep2_gene.tsv
htseq-count --format bam --order pos --mode intersection-strict --stranded reverse --minaqual 1 --type exon --idattr gene_id $RNA_ALIGN_DIR/HBR_Rep3.bam $REF_GTF > HBR_Rep3_gene.tsv

```

Merge results files into a single matrix for use in edgeR:

```bash

join UHR_Rep1_gene.tsv UHR_Rep2_gene.tsv | join - UHR_Rep3_gene.tsv | join - HBR_Rep1_gene.tsv | join - HBR_Rep2_gene.tsv | join - HBR_Rep3_gene.tsv > gene_read_counts_table_all.tsv

```

Based on the above read counts, plot the linearity of the ERCC spike-in read counts versus the known concentration of the ERCC spike-in Mix:

```bash

cd $RNA_HOME/expression/htseq_counts
wget http://genome.wustl.edu/pub/rnaseq/data/brain_vs_uhr_w_ercc/ERCC/ERCC_Controls_Analysis.txt
cat ERCC_Controls_Analysis.txt

wget https://raw.githubusercontent.com/griffithlab/rnaseq_tutorial/master/scripts/Tutorial_Module4_ERCC_expression.pl
chmod +x Tutorial_Module4_ERCC_expression.pl
./Tutorial_Module4_ERCC_expression.pl
cat $RNA_HOME/expression/htseq_counts/ercc_read_counts.tsv

wget https://raw.githubusercontent.com/griffithlab/rnaseq_tutorial/master/scripts/Tutorial_Module4_ERCC_expression.R
chmod +x Tutorial_Module4_ERCC_expression.R
./Tutorial_Module4_ERCC_expression.R ercc_read_counts.tsv

```

To view the resulting figure, navigate to the below URL replacing __YOUR_IP_ADDRESS__ with your amazon instance IP address:
* http://__YOUR_IP_ADDRESS__/workspace/rnaseq/expression/tophat_counts/Tutorial_Module4_ERCC_expression.pdf


| [[Previous Section|PostAlignment-QC]] | [[This Section|Expression]] | [[Next Section|Differential-Expression]] |
|:-------------------------------------:|:---------------------------:|:--------------------------------------------------------:|
| [[Alignment QC|PostAlignment-QC]]     | [[Expression|Expression]]   | [[Differential Expression|Differential-Expression]] |
